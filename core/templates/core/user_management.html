{% extends "core/base.html" %}

{% block content %}

<h2 class="mb-4">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %}

<!-- æœç´¢æ¡† -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="d-flex">
            <input type="text" name="search" class="form-control me-2" 
                   placeholder="æœç´¢ç”¨æˆ·åæˆ–é‚®ç®±..." 
                   value="{{ search_query }}">
            <button type="submit" class="btn btn-primary">
                <i class="fa fa-search"></i> æœç´¢
            </button>
            {% if search_query %}
            <a href="{% url 'user_management' %}" class="btn btn-secondary ms-2">æ¸…é™¤</a>
            {% endif %}
        </form>
    </div>
</div>

<!-- ç”¨æˆ·åˆ—è¡¨ -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">æ‰€æœ‰ç”¨æˆ· ({{ users_with_permissions|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ç”¨æˆ·å</th>
                        <th>é‚®ç®±</th>
                        <th>æ³¨å†Œæ—¶é—´</th>
                        <th>å½“å‰è§’è‰²</th>
                        <th>æƒé™</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in users_with_permissions %}
                    <tr>
                        <td>{{ item.user.id }}</td>
                        <td>
                            {{ item.user.username }}
                            {% if item.user.is_superuser %}
                                <span class="badge bg-danger ms-1">ç®¡ç†å‘˜</span>
                            {% endif %}
                        </td>
                        <td>{{ item.user.email|default:"æœªè®¾ç½®" }}</td>
                        <td>{{ item.user.date_joined|date:"Y-m-d H:i" }}</td>
                        <td>
                            {% if item.groups %}
                                {% for group in item.groups %}
                                    <span class="badge bg-primary me-1">{{ group.name }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">æ— è§’è‰²</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>
                                {% for table_key, perm in item.permissions.items %}
                                    {% if perm.edit %}
                                        <span class="badge bg-success me-1">{{ perm.name|slice:":4" }}âœ“</span>
                                    {% else %}
                                        <span class="badge bg-secondary me-1">{{ perm.name|slice:":4" }}âœ—</span>
                                    {% endif %}
                                {% endfor %}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <!-- è¡¨æƒé™æŒ‰é’® -->
                                <button type="button" class="btn btn-outline-info btn-edit-permission" 
                                        data-user-id="{{ item.user.id }}"
                                        data-username="{{ item.user.username }}">
                                    <i class="fa fa-key"></i> è¡¨æƒé™
                                </button>
                                
                                <!-- æ›´æ”¹è§’è‰²æŒ‰é’® -->
                                <button type="button" class="btn btn-outline-primary btn-edit-role" 
                                        data-user-id="{{ item.user.id }}"
                                        data-username="{{ item.user.username }}"
                                        data-user-groups="{% for group in item.groups %}{{ group.id }},{% endfor %}">
                                    <i class="fa fa-user-cog"></i> è§’è‰²
                                </button>
                                
                                <!-- ç®¡ç†å‘˜æƒé™æŒ‰é’® -->
                                {% if item.user.id != user.id %}
                                <button type="button" class="btn {% if item.user.is_superuser %}btn-warning{% else %}btn-outline-warning{% endif %} btn-toggle-admin" 
                                        data-user-id="{{ item.user.id }}"
                                        data-username="{{ item.user.username }}"
                                        data-is-admin="{{ item.user.is_superuser|yesno:'true,false' }}">
                                    <i class="fa fa-shield-alt"></i> {% if item.user.is_superuser %}å–æ¶ˆç®¡ç†å‘˜{% else %}è®¾ä¸ºç®¡ç†å‘˜{% endif %}
                                </button>
                                {% endif %}
                                
                                <!-- åˆ é™¤æŒ‰é’® -->
                                {% if item.user.id != user.id %}
                                <button type="button" class="btn btn-outline-danger btn-delete-user" 
                                        data-user-id="{{ item.user.id }}"
                                        data-username="{{ item.user.username }}">
                                    <i class="fa fa-trash"></i> åˆ é™¤
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-outline-secondary" disabled>
                                    <i class="fa fa-ban"></i> è‡ªå·±
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- æƒé™æ•°æ®ï¼ˆJSONï¼‰ -->
<script type="application/json" id="permissions-data">
{
    {% for item in users_with_permissions %}
    "{{ item.user.id }}": {{ item.permissions_json|safe }}{% if not forloop.last %},{% endif %}
    {% endfor %}
}
</script>

<!-- æ¨¡æ€æ¡†å®¹å™¨ï¼ˆåŠ¨æ€åŠ è½½ï¼‰ -->
<div id="modalContainer"></div>

<!-- ä¸´æ—¶æµ‹è¯•ï¼šJavaScript æ˜¯å¦èƒ½æ‰§è¡Œ -->
<script>
console.log('æµ‹è¯•1: åœ¨ content block ä¸­çš„è„šæœ¬æ‰§è¡Œäº†å—ï¼Ÿ');
</script>

{% endblock content %}

{% block extra_js %}
<script>
// ç«‹å³æ‰§è¡Œæµ‹è¯•
(function() {
    console.log('=== ç”¨æˆ·ç®¡ç†é¡µé¢ JavaScript å¼€å§‹åŠ è½½ ===');
    
    // æµ‹è¯•ï¼šç«‹å³è¾“å‡º
    if (typeof console !== 'undefined') {
        console.log('âœ“ Console å¯ç”¨');
    } else {
        alert('Console ä¸å¯ç”¨ï¼');
    }
    
    // æµ‹è¯•ï¼šæ£€æŸ¥å…ƒç´ 
    setTimeout(function() {
        console.log('âœ“ å»¶è¿Ÿæ‰§è¡Œæµ‹è¯•');
        const testBtn = document.querySelector('.btn-edit-permission');
        if (testBtn) {
            console.log('âœ“ æ‰¾åˆ°æŒ‰é’®:', testBtn);
            console.log('æŒ‰é’® data-user-id:', testBtn.getAttribute('data-user-id'));
        } else {
            console.error('âœ— æ‰¾ä¸åˆ° .btn-edit-permission æŒ‰é’®');
        }
    }, 500);
})();

// è§£ææƒé™æ•°æ®
let permissionsData = {};
try {
    const permissionsElement = document.getElementById('permissions-data');
    if (permissionsElement) {
        permissionsData = JSON.parse(permissionsElement.textContent);
        console.log('âœ“ æƒé™æ•°æ®åŠ è½½æˆåŠŸ:', Object.keys(permissionsData).length, 'ä¸ªç”¨æˆ·');
    } else {
        console.error('âœ— æ‰¾ä¸åˆ°æƒé™æ•°æ®å…ƒç´ ');
    }
} catch (e) {
    console.error('âœ— è§£ææƒé™æ•°æ®å¤±è´¥:', e);
}

// è·å– CSRF token
const csrfToken = "{{ csrf_token }}";
console.log('âœ“ CSRF Token:', csrfToken ? 'å·²è·å–' : 'æœªè·å–');

// ç­‰å¾… DOM å®Œå…¨åŠ è½½
function initButtons() {
    console.log('=== å¼€å§‹åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶ ===');
    
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer) {
        console.error('âœ— æ‰¾ä¸åˆ° modalContainer å…ƒç´ ');
        return;
    }
    console.log('âœ“ æ‰¾åˆ° modalContainer');
    
    // ç›´æ¥ç»‘å®šåˆ°æ‰€æœ‰æŒ‰é’®
    const permissionButtons = document.querySelectorAll('.btn-edit-permission');
    console.log('âœ“ æ‰¾åˆ°è¡¨æƒé™æŒ‰é’®:', permissionButtons.length, 'ä¸ª');
    
    permissionButtons.forEach((btn, index) => {
        console.log(`ç»‘å®šæŒ‰é’® ${index + 1}:`, btn);
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('>>> ç‚¹å‡»äº†è¡¨æƒé™æŒ‰é’®', this);
            
            const userId = String(this.getAttribute('data-user-id') || this.dataset.userId);
            const username = this.getAttribute('data-username') || this.dataset.username;
            console.log('ç”¨æˆ·ID:', userId, 'ç”¨æˆ·å:', username);
            
            if (!userId || !username) {
                console.error('âœ— ç¼ºå°‘å¿…è¦çš„æ•°æ®å±æ€§', {
                    dataset: this.dataset,
                    attributes: Array.from(this.attributes).map(a => a.name + '=' + a.value)
                });
                alert('é”™è¯¯ï¼šç¼ºå°‘ç”¨æˆ·ä¿¡æ¯');
                return;
            }
            
            const permissions = permissionsData[userId] || {};
            console.log('ç”¨æˆ·æƒé™:', permissions);
            
            // æ„å»ºæƒé™è¡¨å•HTML
            let permissionRows = '';
            const tableNames = {
                'county': 'å¿è¡¨',
                'infra': 'åŸºç¡€è®¾æ–½è¡¨',
                'agri': 'å†œä¸šè¡¨',
                'economy': 'ç»æµè¡¨',
                'demo': 'äººå£ç»Ÿè®¡è¡¨'
            };
            
            Object.keys(tableNames).forEach(tableKey => {
                const perm = permissions[tableKey] || { view: false, edit: false, source: 'role' };
                permissionRows += `
                    <tr>
                        <td>${tableNames[tableKey]}</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       name="view_${tableKey}" 
                                       ${perm.view ? 'checked' : ''}>
                            </div>
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       name="edit_${tableKey}" 
                                       ${perm.edit ? 'checked' : ''}>
                            </div>
                        </td>
                        <td>
                            ${perm.source === 'custom' ? 
                                '<span class="badge bg-info">è‡ªå®šä¹‰</span>' : 
                                '<span class="badge bg-secondary">è§’è‰²</span>'}
                        </td>
                    </tr>
                `;
            });
            
            modalContainer.innerHTML = `
                <div class="modal fade" id="permissionModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">è®¾ç½®ç”¨æˆ·è¡¨æƒé™</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form method="post" action="/manage/users/${userId}/table_permissions/">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                <div class="modal-body">
                                    <p><strong>ç”¨æˆ·ï¼š</strong>${username}</p>
                                    <p class="text-muted"><small>è®¾ç½®ç”¨æˆ·å¯¹æ¯å¼ è¡¨çš„æƒé™ã€‚å¦‚æœæœªè®¾ç½®ï¼Œå°†ä½¿ç”¨è§’è‰²æƒé™ã€‚</small></p>
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>æ•°æ®è¡¨</th>
                                                <th>æŸ¥çœ‹æƒé™</th>
                                                <th>ç¼–è¾‘æƒé™</th>
                                                <th>å½“å‰çŠ¶æ€</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${permissionRows}
                                        </tbody>
                                    </table>
                                    <div class="alert alert-warning">
                                        <small><strong>æ³¨æ„ï¼š</strong>è‡ªå®šä¹‰æƒé™ä¼šè¦†ç›–è§’è‰²æƒé™ã€‚å¦‚æœå–æ¶ˆæ‰€æœ‰è‡ªå®šä¹‰æƒé™ï¼Œå°†æ¢å¤ä½¿ç”¨è§’è‰²æƒé™ã€‚</small>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                                    <button type="submit" class="btn btn-primary">ä¿å­˜æƒé™</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // ç«‹å³æ˜¾ç¤ºæ¨¡æ€æ¡†
            setTimeout(() => {
                const modalElement = document.getElementById('permissionModal');
                if (modalElement) {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                        console.log('âœ“ è¡¨æƒé™æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                    } else {
                        modalElement.style.display = 'block';
                        modalElement.classList.add('show');
                    }
                } else {
                    console.error('âœ— æ‰¾ä¸åˆ°è¡¨æƒé™æ¨¡æ€æ¡†å…ƒç´ ');
                }
            }, 50);
        };
    });
    
    // è§’è‰²ç¼–è¾‘
    const roleButtons = document.querySelectorAll('.btn-edit-role');
    console.log('âœ“ æ‰¾åˆ°è§’è‰²æŒ‰é’®:', roleButtons.length, 'ä¸ª');
    
    roleButtons.forEach((btn, index) => {
        console.log(`ç»‘å®šè§’è‰²æŒ‰é’® ${index + 1}:`, btn);
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('>>> ç‚¹å‡»äº†è§’è‰²æŒ‰é’®', this);
            
            const userId = String(this.getAttribute('data-user-id') || this.dataset.userId);
            const username = this.getAttribute('data-username') || this.dataset.username;
            const userGroups = ((this.getAttribute('data-user-groups') || this.dataset.userGroups) || '').split(',').filter(id => id);
            
            if (!userId || !username) {
                console.error('âœ— ç¼ºå°‘å¿…è¦çš„æ•°æ®å±æ€§');
                alert('é”™è¯¯ï¼šç¼ºå°‘ç”¨æˆ·ä¿¡æ¯');
                return;
            }
            
            // æ„å»ºè§’è‰²é€‰é¡¹HTML
            let roleOptions = '<option value="">-- æ¸…é™¤è§’è‰² --</option>';
            {% for group in all_groups %}
            if (userGroups.includes('{{ group.id }}')) {
                roleOptions += '<option value="{{ group.id }}" selected>{{ group.name }}</option>';
            } else {
                roleOptions += '<option value="{{ group.id }}">{{ group.name }}</option>';
            }
            {% endfor %}
            
            modalContainer.innerHTML = `
                <div class="modal fade" id="roleModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">æ›´æ”¹ç”¨æˆ·è§’è‰²</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form method="post" action="/manage/users/${userId}/change_role/">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                <div class="modal-body">
                                    <p><strong>ç”¨æˆ·ï¼š</strong>${username}</p>
                                    <div class="mb-3">
                                        <label class="form-label">é€‰æ‹©è§’è‰²</label>
                                        <select name="group_id" class="form-select">
                                            ${roleOptions}
                                        </select>
                                    </div>
                                    <div class="alert alert-info">
                                        <small>
                                            <strong>è§’è‰²è¯´æ˜ï¼š</strong><br>
                                            â€¢ <strong>data_entry</strong>ï¼šæ•°æ®å½•å…¥å‘˜ï¼Œå¯ä»¥æŸ¥çœ‹å’Œç¼–è¾‘æ‰€æœ‰è¡¨<br>
                                            â€¢ <strong>analyst</strong>ï¼šåˆ†æå¸ˆï¼Œåªèƒ½æŸ¥çœ‹æ•°æ®ï¼Œä¸èƒ½ç¼–è¾‘
                                        </small>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const modalElement = document.getElementById('roleModal');
                if (modalElement) {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                        console.log('âœ“ è§’è‰²æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                    } else {
                        modalElement.style.display = 'block';
                        modalElement.classList.add('show');
                    }
                }
            }, 50);
        };
    });
    
    // ç®¡ç†å‘˜æƒé™åˆ‡æ¢
    const adminButtons = document.querySelectorAll('.btn-toggle-admin');
    console.log('âœ“ æ‰¾åˆ°ç®¡ç†å‘˜æŒ‰é’®:', adminButtons.length, 'ä¸ª');
    
    adminButtons.forEach((btn, index) => {
        console.log(`ç»‘å®šç®¡ç†å‘˜æŒ‰é’® ${index + 1}:`, btn);
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('>>> ç‚¹å‡»äº†ç®¡ç†å‘˜æŒ‰é’®', this);
            
            const userId = String(this.getAttribute('data-user-id') || this.dataset.userId);
            const username = this.getAttribute('data-username') || this.dataset.username;
            const isAdmin = (this.getAttribute('data-is-admin') || this.dataset.isAdmin) === 'true';
            
            if (!userId || !username) {
                console.error('âœ— ç¼ºå°‘å¿…è¦çš„æ•°æ®å±æ€§');
                alert('é”™è¯¯ï¼šç¼ºå°‘ç”¨æˆ·ä¿¡æ¯');
                return;
            }
            
            modalContainer.innerHTML = `
                <div class="modal fade" id="adminModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${isAdmin ? 'å–æ¶ˆç®¡ç†å‘˜æƒé™' : 'æå‡ä¸ºç®¡ç†å‘˜'}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${isAdmin ? 
                                    `<p>ç¡®å®šè¦å–æ¶ˆç”¨æˆ· <strong>${username}</strong> çš„ç®¡ç†å‘˜æƒé™å—ï¼Ÿ</p>
                                     <p class="text-warning"><small>å–æ¶ˆåï¼Œè¯¥ç”¨æˆ·å°†å¤±å»ç®¡ç†å‘˜æƒé™ï¼Œæ— æ³•è®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢å’ŒDjangoåå°ã€‚</small></p>` :
                                    `<p>ç¡®å®šè¦å°†ç”¨æˆ· <strong>${username}</strong> æå‡ä¸ºç®¡ç†å‘˜å—ï¼Ÿ</p>
                                     <p class="text-info"><small>æå‡åï¼Œè¯¥ç”¨æˆ·å°†æ‹¥æœ‰æ‰€æœ‰ç®¡ç†å‘˜æƒé™ï¼ŒåŒ…æ‹¬ï¼š<br>
                                     â€¢ æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ç”¨æˆ·<br>
                                     â€¢ æ›´æ”¹ç”¨æˆ·è§’è‰²å’Œæƒé™<br>
                                     â€¢ åˆ é™¤ç”¨æˆ·<br>
                                     â€¢ è®¿é—®Djangoåå°</small></p>`}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                                <form method="post" action="/manage/users/${userId}/toggle_admin/" class="d-inline">
                                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                    <button type="submit" class="btn ${isAdmin ? 'btn-warning' : 'btn-success'}">
                                        ${isAdmin ? 'ç¡®è®¤å–æ¶ˆ' : 'ç¡®è®¤æå‡'}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const modalElement = document.getElementById('adminModal');
                if (modalElement) {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                        console.log('âœ“ ç®¡ç†å‘˜æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                    } else {
                        modalElement.style.display = 'block';
                        modalElement.classList.add('show');
                    }
                }
            }, 50);
        };
    });
    
    // åˆ é™¤ç”¨æˆ·
    const deleteButtons = document.querySelectorAll('.btn-delete-user');
    console.log('âœ“ æ‰¾åˆ°åˆ é™¤æŒ‰é’®:', deleteButtons.length, 'ä¸ª');
    
    deleteButtons.forEach((btn, index) => {
        console.log(`ç»‘å®šåˆ é™¤æŒ‰é’® ${index + 1}:`, btn);
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('>>> ç‚¹å‡»äº†åˆ é™¤æŒ‰é’®', this);
            
            const userId = String(this.getAttribute('data-user-id') || this.dataset.userId);
            const username = this.getAttribute('data-username') || this.dataset.username;
            
            if (!userId || !username) {
                console.error('âœ— ç¼ºå°‘å¿…è¦çš„æ•°æ®å±æ€§');
                alert('é”™è¯¯ï¼šç¼ºå°‘ç”¨æˆ·ä¿¡æ¯');
                return;
            }
            
            modalContainer.innerHTML = `
                <div class="modal fade" id="deleteModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">ç¡®è®¤åˆ é™¤</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>ç¡®å®šè¦åˆ é™¤ç”¨æˆ· <strong>${username}</strong> å—ï¼Ÿ</p>
                                <p class="text-danger"><small>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼</small></p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                                <form method="post" action="/manage/users/${userId}/delete/" class="d-inline">
                                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                                    <button type="submit" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const modalElement = document.getElementById('deleteModal');
                if (modalElement) {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                        console.log('âœ“ åˆ é™¤æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                    } else {
                        modalElement.style.display = 'block';
                        modalElement.classList.add('show');
                    }
                }
            }, 50);
        };
    });
    
    console.log('=== æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ ===');
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æŒ‰é’®');
        setTimeout(initButtons, 100);
    });
} else {
    console.log('DOM å·²å°±ç»ªï¼Œç«‹å³åˆå§‹åŒ–æŒ‰é’®');
    setTimeout(initButtons, 100);
}
</script>

{% endblock %}

